<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Simulasi K-Medoids & Dijkstra</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Leaflet.js for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-100 min-h-screen">
<div class="max-w-7xl mx-auto py-8 flex">
    <!-- Sidebar Vertical Tabs -->
    <div class="w-56 flex-shrink-0 pr-6">
        <div class="sticky top-8">
            <div class="flex flex-col gap-2">
                <button data-tab="tab1" class="tab-btn text-left w-full px-4 py-2 rounded-lg transition duration-150 ease-in-out">1. Data & Praproses</button>
                <button data-tab="tab2" class="tab-btn text-left w-full px-4 py-2 rounded-lg transition duration-150 ease-in-out">2. K-Medoids</button>
                <button data-tab="tab3" class="tab-btn text-left w-full px-4 py-2 rounded-lg transition duration-150 ease-in-out">3. Klaster Final</button>
                <button data-tab="tab4" class="tab-btn text-left w-full px-4 py-2 rounded-lg transition duration-150 ease-in-out">4. Dijkstra Steps</button>
                <button data-tab="tab5" class="tab-btn text-left w-full px-4 py-2 rounded-lg transition duration-150 ease-in-out">5. Peta Rute</button>
            </div>
        </div>
    </div>
    <!-- Main Content -->
    <div class="flex-1">
        <h2 class="text-3xl font-extrabold text-center text-blue-800 mb-8 drop-shadow">Simulasi Detail K-Medoids & Dijkstra</h2>
        <div id="simulation-log" class="mb-4"></div>
        <div id="tab1" class="tab-content">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6 border border-gray-200">
                <h4 class="text-2xl font-bold text-blue-700 mb-2">1. Pengumpulan Data</h4>
                <div id="data-collection-table"></div>
                <div id="data-collection-plot" class="my-4" style="height:400px;"></div>
            </div>
        </div>
        <div id="tab2" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6 border border-gray-200">
                <h4 class="text-2xl font-bold text-blue-700 mb-2">2. Proses K-Medoids</h4>
                <div id="kmedoids-steps"></div>
                <div id="kmedoids-plot" class="my-4" style="height:400px;"></div>
            </div>
        </div>
        <div id="tab3" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6 border border-gray-200">
                <h4 class="text-2xl font-bold text-blue-700 mb-2">3. Hasil Klaster Akhir</h4>
                <div id="final-clusters-table"></div>
                <div id="final-clusters-plot" class="my-4" style="height:400px;"></div>
            </div>
        </div>
        <div id="tab4" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6 border border-gray-200">
                <h4 class="text-2xl font-bold text-blue-700 mb-2">4. Proses Dijkstra</h4>
                <div id="dijkstra-steps"></div>
                <div id="dijkstra-graph-plot" class="my-4" style="height:400px;"></div>
            </div>
        </div>
        <div id="tab5" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6 border border-gray-200">
                <h4 class="text-2xl font-bold text-blue-700 mb-2">5. Visualisasi Jalur Terpendek (Peta)</h4>
                <div id="dijkstra-map" style="height:500px;"></div>
            </div>
        </div>
        <div class="mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6 border border-gray-200">
                <h4 class="text-2xl font-bold text-blue-700 mb-4">Parameter Simulasi</h4>
                
                <!-- K-Medoids Parameters -->
                <div class="mb-6">
                    <h5 class="text-lg font-semibold text-blue-600 mb-3">Parameter K-Medoids</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Klaster (K)</label>
                            <input type="number" id="k-clusters" min="2" max="10" value="3" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Maksimum Iterasi</label>
                            <input type="number" id="max-iterations" min="1" max="100" value="10" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- Dijkstra Parameters -->
                <div class="mb-6">
                    <h5 class="text-lg font-semibold text-blue-600 mb-3">Parameter Dijkstra</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Titik Awal</label>
                            <select id="start-point" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Titik Tujuan</label>
                            <select id="end-point" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bobot Jarak (0-100%)</label>
                            <input type="number" id="distance-weight" min="0" max="100" value="50" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div class="form-group">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bobot Risiko (0-100%)</label>
                            <input type="number" id="risk-weight" min="0" max="100" value="50" 
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- Run Simulation Button -->
                <div class="text-right">
                    <button id="run-simulation" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                        Jalankan Simulasi
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
// Vertical Tabs Logic
const tabBtns = document.querySelectorAll('.tab-btn');
const tabContents = document.querySelectorAll('.tab-content');
let dijkstraMapInstance = null; // Declare map instance variable

function activateTab(tabId) {
    tabContents.forEach(tc => tc.classList.add('hidden'));
    const activeTabContent = document.getElementById(tabId);
    if (activeTabContent) {
        activeTabContent.classList.remove('hidden');
    }

    // Reset styles for all buttons
    tabBtns.forEach(btn => {
        btn.classList.remove('bg-blue-500', 'text-white', 'font-semibold', 'ring-2', 'ring-blue-400');
        btn.classList.add('bg-blue-100', 'hover:bg-blue-200', 'text-blue-700');
    });

    // Apply active style to the clicked button
    const activeBtn = Array.from(tabBtns).find(btn => btn.dataset.tab === tabId);
    if (activeBtn) {
        activeBtn.classList.remove('bg-blue-100', 'hover:bg-blue-200', 'text-blue-700');
        activeBtn.classList.add('bg-blue-500', 'text-white', 'font-semibold', 'ring-2', 'ring-blue-400');
    }

    // If the activated tab contains the Dijkstra map, invalidate its size
    if (activeTabContent && activeTabContent.querySelector('#dijkstra-map')) {
        if (dijkstraMapInstance) {
            // Delay slightly to ensure the tab is fully rendered and sized
            setTimeout(() => {
                dijkstraMapInstance.invalidateSize();
            }, 50);
        }
    }
}

tabBtns.forEach(btn => {
    btn.addEventListener('click', () => activateTab(btn.dataset.tab));
});
// Set default tab
activateTab('tab1');

// Simulation logic (unchanged)
document.addEventListener('DOMContentLoaded', function() {
    let districts = []; // Untuk menyimpan daftar district

    // Load initial data
    fetch('/simulation_data')
        .then(res => res.json())
        .then(data => {
            if (data && data.status === 'success') {
                // Populate districts for dropdowns
                districts = [...new Set(data.data_collection.raw_data.map(d => d.district))];
                const startPoint = document.getElementById('start-point');
                const endPoint = document.getElementById('end-point');
                
                districts.forEach(district => {
                    startPoint.add(new Option(district, district));
                    endPoint.add(new Option(district, district));
                });
            }
            renderSimulation(data);
        });

    // Handle simulation parameters
    document.getElementById('run-simulation').addEventListener('click', function() {
        const params = {
            k_clusters: parseInt(document.getElementById('k-clusters').value),
            max_iterations: parseInt(document.getElementById('max-iterations').value),
            start_point: document.getElementById('start-point').value,
            end_point: document.getElementById('end-point').value,
            distance_weight: parseInt(document.getElementById('distance-weight').value),
            risk_weight: parseInt(document.getElementById('risk-weight').value)
        };

        // Validate weights sum to 100%
        if (params.distance_weight + params.risk_weight !== 100) {
            alert('Total bobot harus 100%');
            return;
        }

        // Run simulation with parameters
        fetch('/simulation_data?' + new URLSearchParams(params))
            .then(res => res.json())
            .then(data => renderSimulation(data));
    });

    function renderSimulation(data) {
        if (!data || data.status !== 'success') {
            document.getElementById('simulation-log').innerHTML = '<div class="bg-red-100 text-red-700 p-3 rounded mb-4">Gagal memuat data simulasi.</div>';
            return;
        }
        renderDataCollection(data.data_collection);
        renderKMedoidsSteps(data.kmedoids_steps);
        renderFinalClusters(data.final_clusters);
        renderDijkstraSteps(data.dijkstra_steps);
        renderDijkstraMap(data.dijkstra_steps);
    }

    function safeVal(val, fallback = 'N/A') {
        // Tangani nilai Infinity, -Infinity, string 'Infinity', '∞', dll
        if (
            val === undefined ||
            val === null ||
            val === '' ||
            (typeof val === 'number' && (isNaN(val) || !isFinite(val))) ||
            val === Infinity ||
            val === -Infinity ||
            val === 'Infinity' ||
            val === '-Infinity' ||
            val === '∞'
        ) return fallback;

        // Jika angka, format ke 5 desimal jika perlu
        if (typeof val === 'number' && val % 1 !== 0) {
            // Check if it's a float
            const roundedVal = parseFloat(val.toFixed(5));
            // Check if rounding made it an integer (e.g., 2.000001 rounded to 2)
            // or if it was already an integer that toFixed turned into x.00000
            // We only want to keep decimals if they are significant after rounding.
            if (Math.abs(roundedVal - Math.round(roundedVal)) < 0.000001 && Math.round(roundedVal) === roundedVal) {
                 // If it effectively became an integer or was an integer, show as integer
                 // Or if it's something like 2.0, 2.00, etc.
                 if (String(val).includes('.') && parseFloat(String(val).split('.')[1]) === 0) {
                    return Math.round(roundedVal); // e.g. 2.00000 -> 2
                 } else if (String(roundedVal).includes('.') && parseFloat(String(roundedVal).split('.')[1]) === 0){
                    return Math.round(roundedVal); // e.g. 1.999999 -> 2
                 }
            }
            return roundedVal.toString(); // Return as string to preserve trailing zeros if toFixed created them and they are significant
        }
        return val;
    }

    function renderDataCollection(collection) {
        if (!collection || !collection.raw_data || collection.raw_data.length === 0) {
            document.getElementById('data-collection-table').innerHTML = '<div class="bg-yellow-100 text-yellow-700 p-2 rounded">Data tidak tersedia.</div>';
            return;
        }
        let html = `<div class='mb-2 text-sm text-gray-700'>${safeVal(collection.description)}</div><div class='overflow-x-auto'>`;
        html += renderTable(collection.raw_data.slice(0, 10), '10 Data Pertama');
        html += '</div>';
        document.getElementById('data-collection-table').innerHTML = html + '<div class="text-xs text-gray-500 mt-1">Menampilkan 10 data pertama.</div>';
        // Grafik utama: Fatalities vs Accidents
        let trace = {
            x: collection.raw_data.map(r => safeVal(r.fatalities, 0)),
            y: collection.raw_data.map(r => safeVal(r.accidents, 0)),
            mode: 'markers',
            type: 'scatter',
            text: collection.raw_data.map(r => safeVal(r.district)),
            marker: { size: 10, color: '#2563eb' }
        };
        let beforeDiv = document.createElement('div');
        beforeDiv.id = 'data-collection-plot';
        beforeDiv.style.height = '400px';
        document.getElementById('data-collection-table').appendChild(beforeDiv);
        Plotly.newPlot('data-collection-plot', [trace], {xaxis:{title:'Fatalities'},yaxis:{title:'Accidents'},title:'Sebelum t-SNE: Fatalities vs Accidents'});
        // Grafik tambahan: distribusi fitur (jika ada)
        if (collection.features && collection.features_normalized) {
            // Grafik distribusi fitur asli
            let features = collection.features;
            let fkeys = Object.keys(features[0] || {});
            let featureTraces = fkeys.map(fk => ({
                x: features.map(r => safeVal(r[fk], 0)),
                type: 'histogram',
                name: fk,
                opacity: 0.6
            }));
            let layout1 = {barmode: 'overlay', title: 'Distribusi Fitur Asli', xaxis: {title: 'Value'}, yaxis: {title: 'Count'}};
            let div1 = document.createElement('div');
            div1.id = 'feature-histogram';
            div1.style.height = '320px';
            document.getElementById('data-collection-table').appendChild(div1);
            Plotly.newPlot('feature-histogram', featureTraces, layout1);
            // Grafik distribusi fitur normalisasi
            let featuresNorm = collection.features_normalized;
            let featureNormTraces = fkeys.map(fk => ({
                x: featuresNorm.map(r => safeVal(r[fk], 0)),
                type: 'histogram',
                name: fk,
                opacity: 0.6
            }));
            let layout2 = {barmode: 'overlay', title: 'Distribusi Fitur Normalisasi', xaxis: {title: 'Value'}, yaxis: {title: 'Count'}};
            let div2 = document.createElement('div');
            div2.id = 'feature-histogram-norm';
            div2.style.height = '320px';
            document.getElementById('data-collection-table').appendChild(div2);
            Plotly.newPlot('feature-histogram-norm', featureNormTraces, layout2);
        }
        // Grafik t-SNE jika ada
        if (collection.tsne && collection.tsne.length > 0) {
            let tsneTrace = {
                x: collection.tsne.map(r => safeVal(r.x, 0)),
                y: collection.tsne.map(r => safeVal(r.y, 0)),
                mode: 'markers',
                type: 'scatter',
                text: collection.tsne.map(r => `${safeVal(r.district)}<br>Fatalities: ${safeVal(r.fatalities)}<br>Accidents: ${safeVal(r.accidents)}<br>Cluster: ${safeVal(r.cluster)}`),
                marker: {
                    size: 12,
                    color: collection.tsne.map(r => safeVal(r.cluster, 0)),
                    colorscale: 'Viridis',
                    showscale: true,
                    colorbar: {title: 'Cluster'}
                }
            };
            let tsneDiv = document.createElement('div');
            tsneDiv.id = 'tsne-plot';
            tsneDiv.style.height = '400px';
            document.getElementById('data-collection-table').appendChild(tsneDiv);
            Plotly.newPlot('tsne-plot', [tsneTrace], {title: 'Setelah t-SNE: Visualisasi t-SNE (Clustering)', xaxis: {title: 't-SNE 1'}, yaxis: {title: 't-SNE 2'}});
        }
    }

    function renderKMedoidsSteps(steps) {
        if (!steps || steps.length === 0) {
            document.getElementById('kmedoids-steps').innerHTML = '<div class="bg-yellow-100 text-yellow-700 p-2 rounded">Tahapan K-Medoids tidak tersedia.</div>';
            return;
        }
        let html = '';
        steps.forEach((step, idx) => {
            html += `<div class="mb-4 border-b border-blue-100 pb-2"><div class="font-semibold text-blue-700">${safeVal(step.step_name)}</div><div class="text-gray-700 mb-2">${safeVal(step.description)}</div>`;
            if (step.medoids) {
                html += renderTable(step.medoids, 'Medoids');
            }
            if (step.cluster_assignments) {
                html += renderTable(step.cluster_assignments.slice(0, 10), 'Cluster Assignments (10 data)');
            }
            if (step.total_cost !== undefined) {
                html += `<div class="text-xs text-blue-700 font-bold">Total Cost: ${safeVal(step.total_cost, 0)}</div>`;
            }
            if (step.old_medoids) {
                html += '<div class="text-xs font-semibold">Old Medoids:</div>' + renderTable(step.old_medoids);
            }
            if (step.new_medoids) {
                html += '<div class="text-xs font-semibold">New Medoids:</div>' + renderTable(step.new_medoids);
            }
            if (step.old_cost !== undefined && step.new_cost !== undefined) {
                html += `<div class="text-xs">Old Cost: ${safeVal(step.old_cost, 0)} | New Cost: ${safeVal(step.new_cost, 0)}</div>`;
            }
            html += '</div>';
        });
        document.getElementById('kmedoids-steps').innerHTML = html;
        let lastAssign = [...steps].reverse().find(s => s.cluster_assignments);
        if (lastAssign) {
            let clusters = [...new Set(lastAssign.cluster_assignments.map(r => safeVal(r.cluster, 0)))];
            let traces = clusters.map(c => {
                let pts = lastAssign.cluster_assignments.filter(r => safeVal(r.cluster, 0) === c);
                return {
                    x: pts.map(r => safeVal(r.fatalities, 0)),
                    y: pts.map(r => safeVal(r.accidents, 0)),
                    mode: 'markers',
                    type: 'scatter',
                    name: 'Cluster ' + c,
                    text: pts.map(r => safeVal(r.district)),
                    marker: { size: 10 }
                };
            });
            Plotly.newPlot('kmedoids-plot', traces, {xaxis:{title:'Fatalities'},yaxis:{title:'Accidents'},title:'Cluster Assignment'});
        }
    }

    function renderFinalClusters(final_clusters) {
        if (!final_clusters || Object.keys(final_clusters).length === 0) {
            document.getElementById('final-clusters-table').innerHTML = '<div class="bg-yellow-100 text-yellow-700 p-2 rounded">Hasil klaster tidak tersedia.</div>';
            return;
        }
        let html = '';
        Object.entries(final_clusters).forEach(([cid, cdata]) => {
            html += `<div class="mb-4 border-b border-blue-100 pb-2"><div class="font-semibold text-blue-700">${safeVal(cid)}</div>`;
            html += `<div class="text-xs">Medoid: <span class="font-semibold text-blue-600">${safeVal(cdata.medoid?.district)}</span></div>`;
            html += `<div class="text-xs">Dominant Risk Level: <span class="font-semibold">${safeVal(cdata.dominant_risk_level)}</span></div>`;
            html += `<div class="text-xs">Avg Risk Score: <span class="font-semibold">${safeVal(cdata.avg_risk_score, 0)}</span></div>`;
            html += `<div class="text-xs">Jumlah Titik: <span class="font-semibold">${safeVal(cdata.count, 0)}</span></div>`;
            html += renderTable((cdata.points||[]).slice(0, 10), '10 Data Pertama');
            html += '</div>';
        });
        document.getElementById('final-clusters-table').innerHTML = html;
        let traces = [];
        Object.values(final_clusters).forEach((c, idx) => {
            traces.push({
                x: (c.points||[]).map(r => safeVal(r.fatalities, 0)),
                y: (c.points||[]).map(r => safeVal(r.accidents, 0)),
                mode: 'markers',
                type: 'scatter',
                name: 'Cluster ' + idx,
                text: (c.points||[]).map(r => safeVal(r.district)),
                marker: { size: 10 }
            });
        });
        Plotly.newPlot('final-clusters-plot', traces, {xaxis:{title:'Fatalities'},yaxis:{title:'Accidents'},title:'Final Clusters'});
    }

    function renderDijkstraSteps(steps) {
        if (!steps || steps.length === 0) {
            document.getElementById('dijkstra-steps').innerHTML = '<div class="bg-yellow-100 text-yellow-700 p-2 rounded">Tahapan Dijkstra tidak tersedia.</div>';
            return;
        }
        let html = '';
        steps.forEach((step, idx) => {
            html += `<div class="mb-4 border-b border-blue-100 pb-2"><div class="font-semibold text-blue-700">${safeVal(step.step_name)}</div><div class="text-gray-700 mb-2">${safeVal(step.description)}</div>`;
            if (step.distances) {
                html += '<div class="text-xs">Distances: ' + JSON.stringify(step.distances) + '</div>';
            }
            if (step.visited) {
                html += '<div class="text-xs">Visited: ' + step.visited.join(', ') + '</div>';
            }
            if (step.unvisited) {
                html += '<div class="text-xs">Unvisited: ' + step.unvisited.join(', ') + '</div>';
            }
            if (step.neighbor_updates) {
                html += renderTable(step.neighbor_updates, 'Neighbor Updates');
            }
            if (step.graph) {
                html += '<div class="text-xs font-semibold">Graph Structure:</div>' + renderTable(step.graph.nodes, 'Nodes') + renderTable(step.graph.edges, 'Edges');
            }
            if (step.path_segments) {
                html += renderTable(step.path_segments, 'Path Segments');
            }
            if (step.path) {
                html += '<div class="text-xs">Path: ' + step.path.join(' → ') + '</div>';
            }
            if (step.total_distance !== undefined) {
                html += `<div class="text-xs font-bold text-blue-700">Total Distance: ${safeVal(step.total_distance, 0)} km</div>`;
            }
            if (step.total_weighted_distance !== undefined) {
                html += `<div class="text-xs font-bold text-blue-700">Total Weighted Distance: ${safeVal(step.total_weighted_distance, 0)} km</div>`;
            }
            html += '</div>';
        });
        document.getElementById('dijkstra-steps').innerHTML = html;
        let graphStep = steps.find(s => s.graph);
        if (graphStep) {
            let nodes = graphStep.graph.nodes;
            let edges = graphStep.graph.edges;
            let edgeTraces = edges.map(e => {
                let from = nodes.find(n => n.id === safeVal(e.source));
                let to = nodes.find(n => n.id === safeVal(e.target));
                return {
                    x: [safeVal(from?.lng, 0), safeVal(to?.lng, 0)],
                    y: [safeVal(from?.lat, 0), safeVal(to?.lat, 0)],
                    mode: 'lines',
                    line: {width: 2, color: '#888'},
                    showlegend: false
                };
            });
            let nodeTrace = {
                x: nodes.map(n => safeVal(n.lng, 0)),
                y: nodes.map(n => safeVal(n.lat, 0)),
                mode: 'markers+text',
                type: 'scatter',
                text: nodes.map(n => safeVal(n.id)),
                textposition: 'top center',
                marker: {size: 12, color: '#2563eb'},
                name: 'Districts'
            };
            Plotly.newPlot('dijkstra-graph-plot', [...edgeTraces, nodeTrace], {xaxis:{title:'Longitude'},yaxis:{title:'Latitude'},title:'Graph Structure'});
        }
    }

    function renderDijkstraMap(steps) {
        const mapContainer = document.getElementById('dijkstra-map');
        if (!mapContainer) {
            console.error('Map container #dijkstra-map not found!');
            return;
        }

        // If a map instance already exists, remove it before creating a new one
        if (dijkstraMapInstance) {
            dijkstraMapInstance.remove();
            dijkstraMapInstance = null;
        }

        if (!steps || steps.length === 0) {
            mapContainer.innerHTML = '<div class="p-4 text-center text-gray-500">Data langkah Dijkstra tidak tersedia untuk peta.</div>';
            return;
        }
        
        let lastStep = [...steps].reverse().find(s => s.path_segments);
        if (!lastStep || !lastStep.path_segments || lastStep.path_segments.length === 0) {
            mapContainer.innerHTML = '<div class="p-4 text-center text-gray-500">Data jalur (path segments) tidak ditemukan untuk ditampilkan di peta.</div>';
            // Optionally, initialize a map with a default view if desired even with no path
            // dijkstraMapInstance = L.map('dijkstra-map').setView([5.10, 97.20], 9); // Aceh Utara/Lhokseumawe
            // L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            //     attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            //     maxZoom: 18,
            // }).addTo(dijkstraMapInstance);
            return;
        }

        const firstSegment = lastStep.path_segments[0];
        let initialCoords = [5.10, 97.20]; // Default initial coords (Lhokseumawe/Aceh Utara general area)
        let initialZoom = 9;

        if (firstSegment && firstSegment.from_coords && typeof firstSegment.from_coords.lat === 'number' && typeof firstSegment.from_coords.lng === 'number') {
            initialCoords = [firstSegment.from_coords.lat, firstSegment.from_coords.lng];
            initialZoom = 10;
        }

        try {
            dijkstraMapInstance = L.map('dijkstra-map').setView(initialCoords, initialZoom);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18,
            }).addTo(dijkstraMapInstance);

            let latlngs = [];
            lastStep.path_segments.forEach(seg => {
                if (seg.from_coords && typeof seg.from_coords.lat === 'number' && typeof seg.from_coords.lng === 'number') {
                    latlngs.push([seg.from_coords.lat, seg.from_coords.lng]);
                }
            });
            
            const lastSegmentData = lastStep.path_segments[lastStep.path_segments.length - 1];
            if (lastSegmentData && lastSegmentData.to_coords && typeof lastSegmentData.to_coords.lat === 'number' && typeof lastSegmentData.to_coords.lng === 'number') {
                latlngs.push([lastSegmentData.to_coords.lat, lastSegmentData.to_coords.lng]);
            }

            if (latlngs.length > 1) { // Need at least two points for a polyline
                let polyline = L.polyline(latlngs, { color: '#ef4444', weight: 6 }).addTo(dijkstraMapInstance);
                dijkstraMapInstance.fitBounds(polyline.getBounds());
            } else if (latlngs.length === 1) { // Only one point, just center on it
                 dijkstraMapInstance.setView(latlngs[0], 13); // Zoom in a bit more for a single point
            }
            // If latlngs is empty, map is already centered on initialCoords

            lastStep.path_segments.forEach(seg => {
                if (seg.from_coords && typeof seg.from_coords.lat === 'number' && typeof seg.from_coords.lng === 'number' && seg.from) {
                    L.marker([seg.from_coords.lat, seg.from_coords.lng], { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [28, 28], iconAnchor: [14, 28], popupAnchor: [0, -28] }) }).addTo(dijkstraMapInstance).bindPopup(seg.from);
                }
            });
            if (lastSegmentData && lastSegmentData.to_coords && typeof lastSegmentData.to_coords.lat === 'number' && typeof lastSegmentData.to_coords.lng === 'number' && lastSegmentData.to) {
                L.marker([lastSegmentData.to_coords.lat, lastSegmentData.to_coords.lng], { icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [28, 28], iconAnchor: [14, 28], popupAnchor: [0, -28] }) }).addTo(dijkstraMapInstance).bindPopup(lastSegmentData.to);
            }
            
            // Ensure map size is correct if it was initialized while hidden
            // This is primarily handled by activateTab, but an extra call here after data load might be safe
            setTimeout(() => {
                if (dijkstraMapInstance && mapContainer.offsetParent !== null) { // Check if visible
                     dijkstraMapInstance.invalidateSize();
                }
            }, 100);

        } catch (e) {
            console.error("Error rendering Dijkstra map:", e);
            mapContainer.innerHTML = `<div class="p-4 text-center text-red-500">Error rendering map: ${e.message}. Periksa konsol untuk detail.</div>`;
        }
    }

    function renderTable(data, title) {
        if (!data || data.length === 0) return '';
        let keys = Object.keys(data[0]);
        let html = title ? `<div class='font-semibold text-blue-700 mb-1'>${title}</div>` : '';
        html += `<div class="overflow-x-auto">
        <table class="w-full border border-blue-200 rounded-lg overflow-x-auto text-xs table-auto shadow-sm">
        <thead>
            <tr>
                ${keys.map(k => `<th class='bg-blue-100 text-blue-800 px-3 py-2 border-b border-blue-200 font-semibold text-xs uppercase tracking-wider text-center'>${k}</th>`).join('')}
            </tr>
        </thead>
        <tbody>
        `;
        data.forEach((row, idx) => {
            html += `<tr class="${idx % 2 === 0 ? 'bg-white' : 'bg-blue-50'} hover:bg-blue-200 transition">` +
                keys.map(k => `<td class='px-3 py-2 border-b border-blue-100 text-center whitespace-nowrap'>${safeVal(row[k], (typeof row[k] === 'number' ? 0 : 'N/A'))}</td>`).join('') + '</tr>';
        });
        html += '</tbody></table></div>';
        return html;
    }
});
</script>
</body>
</html>
